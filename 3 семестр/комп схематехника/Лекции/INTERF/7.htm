<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>

<head>
<title>7.htm</title>
<meta http-equiv="Content-Type" content="text/html;charset=windows-1251">
</head>

<body background="back1.jpg">

<p>&nbsp;<font FACE="Arial" SIZE="6"><b></p>

<p>7. Последовательные шины</b></font><font FACE="Times New Roman"
SIZE="2"></p>

<p>Последовательные шины позволяют объединять
множество устройств, используя всего 1-2 пары
проводов. При этом достигается пропускная
способность от 100 кбит/с для шины ACCESS.Bus до 400
Мбит/с у FireWire. Функциональные возможности этих
шин гораздо шире, чем у традиционных интерфейсов
локальных сетей — USB и FireWire способны передавать
изохронный трафик аудио- и видеоданных.</font><font
FACE="Arial" SIZE="4"><b></p>

<p>7.1. Шина USB</b></font><font FACE="Times New Roman" SIZE="2"><i></p>

<p>USB</i> (Universal Serial Bus — универсальная
последовательная шина) является промышленным
стандартом расширения архитектуры PC,
ориентированным на интеграцию с телефонией и
устройствами бытовой электроники. Версия 1.0 была
опубликована в январе 1996 года. Архитектура USB
определяется следующими критериями:</p>

<p>* Легко реализуемое расширение периферии PC.</p>
<i>

<p>*</i> Дешевое решение, поддерживающее скорость
передачи до 12 Мбит/с.</p>
<i>

<p>*</i> Полная поддержка в реальном времени
передачи аудио-и (сжатых) видеоданных.</p>

<p>* Гибкость протокола смешанной передачи
изохронных данных и асинхронных сообщений.</p>

<p>* Интеграция с выпускаемыми устройствами. ^
Доступность в PC всех конфигураций и размеров.</p>
<i>

<p>*</i> Обеспечение стандартного интерфейса,
способного быстро завоевать рынок.</p>

<p>* Создание новых классов устройств, расширяющих
PC.</p>

<p>С точки зрения конечного пользователя,
привлекательны следующие черты USB:</p>

<p>^ Простота кабельной системы и подключений.</font></p>

<p><font face="Times New Roman" size="2">* Скрытие подробностей
электрического подключения от<br>
конечного пользователя.</font> </p>

<p><font face="Times New Roman" size="2">*Самоидентифицирующиеся
ПУ, автоматическая связь<br>
устройств с драйверами и конфигурирование.</font> </p>

<p><font face="Times New Roman" size="2"><i>*</i> Возможность
динамического подключения и конфигури-<br>
рования ПУ.</font> </p>

<p><font face="Times New Roman" size="2">С середины 1996 года
выпускаются PC со встроенным кон-<br>
троллером USB, реализуемым чипсетом. Ожидается
появ-<br>
ление модемов, клавиатур, сканеров, динамиков и
других<br>
устройств ввода/вывода с поддержкой USB, а также
мони-<br>
торов с USB-адаптерами - они будут играть роль
хабов для<br>
подключения других устройств.</font> </p>

<p><font face="Times New Roman" size="3"><b>7.1.1. Структура USB</b></font> </p>

<p><font face="Times New Roman" size="2">USB обеспечивает
одновременный обмен данными между<br>
<i>хост-компьютером</i> и множеством <i>периферийных
устройств<br>
(ПУ).</i> Распределение пропускной способности
шины между<br>
ПУ планируется хостом и реализуется им с помощью
по-<br>
сылки маркеров. Шина позволяет подключать,
конфигури-<br>
ровать, использовать и отключать устройства во
время ра-<br>
боты хоста и самих устройств.</font> </p>

<p><font face="Times New Roman" size="2">Ниже приводится авторский
вариант перевода терминов<br>
из спецификации &quot;Universal Serial Bus Specification. Revi-<br>
sion I.O.January 15, 1996&quot;, опубликованной Compaq, DEC,<br>
IBM, Intel, Microsoft, NEC и Northern Telecom. Более под-<br>
робную и оперативную информацию можно найти по
ад-<br>
ресу: <a href="http://www.usb.org">http://www.usb.org</a>.</font> </p>

<p><font face="Times New Roman" size="2"><i>Устройства (Device)</i> USB
могут являться хабами, функция-<br>
ми или их комбинацией. <i>Хаб</i> (Hub) обеспечивает
дополни-<br>
тельные точки подключения устройств к шине. <i>Функции<br>
(Function)</i> USB предоставляют системе дополнительные
воз-<br>
можности, например подключение к ISDN, цифровой
джой-<br>
стик, акустические колонки с цифровым
интерфейсом и т. п.<br>
Устройство USB должно иметь интерфейс USB, обеспечи-<br>
вающий полную поддержку протокола USB, выполнение<br>
стандартных операций (конфигурирование и сброс)
и пре-<br>
доставление информации, описывающей устройство.
Мно-</font> </p>

<hr>

<p><font face="Times New Roman" size="2">гие устройства,
подключаемые к USB, имеют в своем соста-<br>
ве и хаб, и функции. Работой всей системы USB
управляет<br>
<i>хост-контроллер (Host Controller),</i> являющийся
программно-<br>
аппаратной подсистемой хост-компьютера.</font> </p>

<p><font face="Times New Roman" size="2"><i>Физическое соединение</i>
устройств осуществляется по топо-<br>
логии многоярусной <i>звезды.</i> Центром каждой
звезды явля-<br>
ется <i>хаб,</i> каждый кабельный сегмент соединяет
две точки -<br>
хаб с другим хабом или с функцией. В системе
имеется один<br>
(и только один) <i>хост-контроллер,</i>
расположенный в верши-<br>
не пирамиды устройств и хабов. Хост-контроллер
интегри-<br>
руется с <i>корневым хабом (Root Hub),</i>
обеспечивающим одну<br>
или несколько точек подключения - <i>портов.</i>
Контроллер<br>
USB, входящий в состав чипсетов, обычно имеет
встроен-<br>
ный двухпортовый хаб. Логически устройство,
подключен-<br>
ное к любому хабу USB и сконфигурированное (см.
ниже),<br>
может рассматриваться как непосредственно
подключенное<br>
к хост-контроллеру.</font> </p>

<p><font face="Times New Roman" size="2"><i>Функции</i> представляют
собой устройства, способные пере-<br>
давать или принимать данные или управляющую
информа-<br>
цию по шине. Типично функции представляют собой
отдель-<br>
ные ПУ с кабелем, подключаемым к порту хаба.
Физически<br>
в одном корпусе может быть несколько функций со
встро-<br>
енным хабом, обеспечивающим их подключение к
одному<br>
порту. Эти комбинированные устройства для хоста
являют-<br>
ся хабами с постоянно подключенными
устройствами-функ-<br>
циями.</font> </p>

<p><font face="Times New Roman" size="2">Каждая функция
предоставляет конфигурационную инфор-<br>
мацию, описывающую возможности ПУ и требования к
ре-<br>
сурсам. Перед использованием функция должна быть
скон-<br>
фигурирована хостом - ей должна быть выделена
полоса в<br>
канале и выбраны опции конфигурации.</font> </p>

<p><font face="Times New Roman" size="2">Примерами функций
являются:</font> </p>

<p><font face="Times New Roman" size="2">^ Указатели - мышь, планшет,
световое перо.<br>
^ Устройства ввода - клавиатура или сканер.</font> </p>

<p><font face="Times New Roman" size="2">^ Устройство вывода -
принтер, звуковые колонки (циф-<br>
ровые).</font> </p>

<p><font face="Times New Roman" size="2"><i>т</i> Телефонный адаптер
ISDN.</font> </p>

<hr>

<p><font face="Times New Roman" size="2"><i>Хаб -</i> ключевой элемент
системы РпР в архитектуре USB.<br>
Хаб является кабельным концентратором. Точки
подключе-<br>
ния называются <i>портами</i> хаба. Каждый хаб
преобразует одну<br>
точку подключения в их множество. Архитектура
допускает<br>
соединение нескольких хабов.</font> </p>

<p><font face="Times New Roman" size="2">У каждого хаба имеется
один <i>восходящий порт (Upstream<br>
Port},</i> предназначенный для подключения к хосту
или хабу<br>
верхнего уровня. Остальные порты являются <i>нисходящими<br>
(Downstream Ports),</i> предназначенными для подключения<br>
функций или хабов нижнего уровня. Хаб может
распознать<br>
подключение устройств к портам или отключение от
них и<br>
управлять подачей питания на их сегменты. Каждый
из пор-<br>
тов может быть разрешен или запрещен и
сконфигурирован<br>
на полную или ограниченную скорость обмена. Хаб
обеспе-<br>
чивает изоляцию сегментов с низкой скоростью от
высоко-<br>
скоростных.</font> </p>

<p><font face="Times New Roman" size="2">Хабы могут управлять
подачей питания на нисходящие пор-<br>
ты; предусматривается установка ограничения на
ток, по-<br>
требляемый каждым портом.</font> </p>

<p><img border="0" vspace="3" hspace="3" src="71.jpg" alt="71.jpg" width="924"
height="708"> <br clear="all">
</p>

<hr>

<p><font face="Times New Roman" size="2"><i>Система USB</i> разделяется
на три уровня с определенными<br>
правилами взаимодействия. Устройство USB содержит
ин-<br>
терфейсную часть, часть устройства и
функциональную<br>
часть. Хост тоже делится на три части -
интерфейсную, си-<br>
стемную и ПО устройства. Каждая часть отвечает
только за<br>
определенный круг задач, логическое и реальное
взаимодей-<br>
ствие между ними иллюстрирует рис. 7.1.</font> </p>

<p><font face="Times New Roman" size="2">В рассматриваемую
структуру входят следующие элементы:</font> </p>

<p><font face="Times New Roman" size="2">^ <i>Физическое устройство
USB -</i> устройство на шине, вы-<br>
полняющее функции, интересующие конечного
пользо-<br>
вателя.</font> </p>

<p><font face="Times New Roman" size="2">^ <i>Client SW -</i> ПО,
соответствующее конкретному устрой-<br>
ству, исполняемое на хост-компьютере. Может
являться<br>
составной частью ОС или специальным продуктом.</font>
</p>

<p align="center"><font face="Times New Roman" size="2">^ <i>USB System SW -</i>
системная поддержка USB, независи-<br>
мая от конкретных устройств и клиентского ПО.</font>
</p>

<p><font face="Times New Roman" size="2">^ <i>USB Host Controller -</i>
аппаратные и программные сред-<br>
ства для подключения устройств USB к
хост-компьютеру.</font> </p>

<p><font face="Times New Roman" size="2"><b>Физический интерфейс</b></font>
</p>

<p><font face="Times New Roman" size="2">Стандарт USB определяет
электрические и механические спе-<br>
цификации шины.</font> </p>

<p><font face="Times New Roman" size="2">Информационные сигналы и
питающее напряжение 5 В пе-<br>
редаются по четырехпроводному кабелю.
Используется диф-<br>
ференциальный способ передачи сигналов D+ и D- по
двум<br>
проводам. Уровни сигналов передатчиков в
статическом<br>
режиме должны быть ниже 0,3 В (низкий уровень) или
выше<br>
2,8 В (высокий уровень). Приемники выдерживают
входное<br>
напряжение в пределах - 0,5...+3,8 В. Передатчики
должны<br>
уметь переходить в высокоимпедансное состояние
для дву-<br>
направленной полудуплексной передачи по одной
паре про-<br>
водов.</font> </p>

<p><font face="Times New Roman" size="2">Передача по двум проводам
в USB не ограничивается диф-<br>
ференциальными сигналами. Кроме
дифференциального<br>
приемника каждое устройство имеет линейные
приемники<br>
сигналов D+ и D-, а передатчики этих линий
управляются<br>
индивидуально. Это позволяет различать более
двух состоя-</font> </p>

<p><font face="Times New Roman" size="1">10 Зак. № 530</font> </p>

<hr>

<p><font face="Times New Roman" size="2">ний линии, используемых
для организации аппаратного ин-<br>
терфейса. Состояния <i>DiffO</i> и <i>Diff1</i> определяются
по разно-<br>
сти потенциалов на линиях D+ и D- более 200 мВ при<br>
условии, что на одной из них потенциал выше
порога сраба-<br>
тывания VSE. Состояние, при котором на обоих входах
D+ и<br>
D- присутствует низкий уровень, называется <i>линейным
ну-<br>
лем (SEO - Single-Ended Zero).</i> Интерфейс определяет следу-<br>
ющие состояния:</font> </p>

<p><font face="Times New Roman" size="2">йа <i>DataJ State</i> и <i>Data К State -</i>
состояния передаваемого<br>
бита (или просто <i>J</i> и <i>К),</i> определяются через
состояния<br>
<i>DiffO</i> и <i>Diff1.</i></font> </p>

<p><font face="Times New Roman" size="2"><i>^ Idle State -</i> пауза на шине.</font>
</p>

<p><font face="Times New Roman" size="2">^ <i>Resume State -</i> сигнал
&quot;пробуждения&quot; для вывода устрой-<br>
ства из &quot;спящего&quot; режима.</font> </p>

<p><font face="Times New Roman" size="2">^ <i>Start of Packet (SOP) -</i> начало
пакета (переход из <i>Idle State<br>
в К).</i></font> </p>

<p><font face="Times New Roman" size="2"><i>т End of Packet (EOP) -</i> конец
пакета.<br>
^ <i>Disconnect -</i> устройство отключено от порта.<br>
^ <i>Connect -</i> устройство подключено к порту.<br>
^ <i>Reset -</i> сброс устройства.</font> </p>

<p><font face="Times New Roman" size="2">Состояния определяются
сочетаниями дифференциальных<br>
и линейных сигналов; для полной и низкой
скоростей со-<br>
стояния <i>DiffO</i> и <i>Diff1</i> имеют противоположное
назначение.<br>
В декодировании состояний <i>Disconnect, Connect</i> и <i>Reset</i>
учи-<br>
тывается время нахождения линий (более 2,5 мс) в
опреде-<br>
ленных состояниях.</font> </p>

<p><font face="Times New Roman" size="2">Шина имеет два режима
передачи. <i>Полная скорость</i> передачи<br>
сигналов USB составляет 12 Мбит/с, <i>низкая -</i> 1,5
Мбит/с. Для<br>
полной скорости используется экранированная
витая пара<br>
с импедансом 90 Ом и длиной сегмента до 5 м, для
низкой -<br>
невитой неэкранированньгй кабель до 3 м.
Низкоскоростные<br>
кабели и устройства дешевле высокоскоростных.
Одна и та<br>
же система может одновременно использовать оба
режима;</font> </p>

<p><font face="Times New Roman" size="2">переключение для
устройств осуществляется прозрачно.<br>
Низкая скорость предназначена для работы с
небольшим<br>
количеством ПУ, не требующих высокой скорости.</font>
</p>

<hr>

<p><font face="Times New Roman" size="2">Скорость, используемая
устройством, подключенным к кон-<br>
кретному порту, определяется хабом по уровням
сигналов<br>
на линиях D+ и D-, смещаемых нагрузочными
резисторами<br>
R2 приемопередатчиков (см. рис. 7.2 и 7.3).</font> </p>

<p><font face="Times New Roman" size="2">Сигналы синхронизации
кодируются вместе с данными по<br>
методу <i>NRZI (Non Return to Zero Invert),</i> его работу иллюст-<br>
рирует рис. 7.4. Каждому пакету предшествует поле
синх-<br>
ронизации <i>SYNC,</i> позволяющее приемнику
настроиться на<br>
частоту передатчика.</font> </p>

<p><font face="Times New Roman" size="2">Кабель также имеет линии
VBus и GND для передачи питающего<br>
напряжения 5 В к устройствам. Сечение проводников
выби-<br>
рается в соответствии с длиной сегмента для
обеспечения га-<br>
рантированного уровня сигнала и питающего
напряжения.</font> </p>

<p><img border="0" vspace="3" hspace="3" src="72.jpg" alt="72.jpg" width="920"
height="868"> <br clear="all">
</p>

<p align="center"><font face="Times New Roman" size="2"><b>Рис. 7.4.</b>
Кодирование данных по методу NRZI</font> </p>

<hr>

<p><font face="Times New Roman" size="2">Стандарт определяет <i>два
типа разъемов</i> (см. табл. 7.1 и<br>
рис. 7.5).</font> </p>

<table align="left" border="1">
  <tr>
    <td><font face="Times New Roman" size="2"><b>Контакт</b></font> </td>
    <td><font face="Times New Roman" size="2"><b>Цепь</b></font> </td>
    <td><font face="Times New Roman" size="2"><b>Контакт</b></font> </td>
    <td><font face="Times New Roman" size="2"><b>Цепь</b></font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2"><b>1</b></font> </td>
    <td><font face="Times New Roman" size="2"><b>VBus</b></font> </td>
    <td><font face="Times New Roman" size="2"><b>3</b></font> </td>
    <td><font face="Times New Roman" size="2"><b>D+</b></font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2"><b>2</b></font> </td>
    <td><font face="Times New Roman" size="2"><b>D-</b></font> </td>
    <td><font face="Times New Roman" size="2"><b>4</b></font> </td>
    <td><font face="Times New Roman" size="2"><b>GND</b></font> </td>
  </tr>
</table>

<p><br clear="all">
</p>

<p><font face="Times New Roman" size="2"><i>Разъемы типа &quot;А&quot;</i>
применяются для подключения к хабам<br>
<i>(Upstream Connector).</i> Вилки устанавливаются на
кабелях, не<br>
отсоединяемых от устройств (например,
клавиатура, мышь<br>
и т. п.). Гнезда устанавливаются на нисходящих
портах<br>
<i>(Downstream Port)</i> хабов.</font> </p>

<p><font face="Times New Roman" size="2"><i>Разъемы типа &quot;В&quot;
(Downstream Connector)</i> устанавливаются<br>
на устройствах, от которых соединительный кабель
может<br>
отсоединяться (принтеры и сканеры). Ответная
часть (вилка)<br>
устанавливается на соединительном кабеле,
противополож-<br>
ный конец которого имеет вилку типа &quot;А&quot;.</font> </p>

<p><font face="Times New Roman" size="2">Разъемы типов &quot;А&quot; и
&quot;В&quot; различаются механически<br>
(рис. 7.5), что исключает недопустимые петлевые
соедине-<br>
ния портов хабов. Четырехконтактные разъемы
имеют клю-<br>
чи, исключающие неправильное присоединение.
Конструк-<br>
ция разъемов обеспечивает позднее соединение и
раннее<br>
отсоединение сигнальных цепей по сравнению с
питающи-<br>
ми. Для распознавания разъема USB на корпусе
устройства<br>
ставится стандартное символическое обозначение.</font>
</p>

<p><img border="0" vspace="3" hspace="3" src="73.jpg" alt="73.jpg" width="888"
height="268"> <br clear="all">
</p>

<p align="center"><font face="Times New Roman" size="2"><b>Рис. 7.5.</b> Гнезда
USB: а - типа &quot;А&quot;, <i>б -</i> типа &quot;В&quot;,<br>
в - символическое обозначение</font> </p>

<p><font face="Times New Roman" size="2"><i>Питание устройств</i> USB
возможно <i>от кабеля (Bus-Powered<br>
Devices)</i> или от собственного блока питания <i>(Self-Powered</i></font>
</p>

<hr>

<p><font face="Times New Roman" size="2"><i>Devices).</i> Хост
обеспечивает питанием непосредственно под-<br>
ключенные к нему ПУ. Каждый хаб, в свою очередь,
обеспе-<br>
чивает питание устройств, подключенных к его
нисходящим<br>
портам. При некоторых ограничениях топологии
допуска-<br>
ется применение хабов, питающихся от шины. На рис.
7.6<br>
приведен пример схемы соединения устройств USB.
Здесь<br>
клавиатура, перо и мышь могут питаться от шины.</font>
</p>

<p><img border="0" vspace="3" hspace="3" src="74.jpg" alt="74.jpg" width="860"
height="596"> <br clear="all">
</p>

<p><font face="Times New Roman Narrow" size="2"><b>Модель передачи
данных</b></font> </p>

<p><font face="Times New Roman" size="2">Каждое устройство USB
представляет собой набор незави-<br>
симых <i>конечных точек (Endpoint), с</i> которыми
хост-контрол-<br>
лер обменивается информацией. Конечные точки
описыва-<br>
ются следующими параметрами:</font> </p>

<p><font face="Times New Roman" size="2"><i>^</i> требуемой частотой
доступа к шине и допустимыми за-<br>
держками обслуживания;</font> </p>

<p><font face="Times New Roman" size="2">^ требуемой полосой
пропускания канала;</font> </p>

<p><font face="Times New Roman" size="2">^ номером точки;</font> </p>

<p><font face="Times New Roman" size="2">^ требованиями к обработке
ошибок;</font> </p>

<p><font face="Times New Roman" size="2">^ максимальными размерами
передаваемых и принимаемых<br>
пакетов;</font> </p>

<hr>

<p><font face="Times New Roman" size="2">^ типом обмена;</font> </p>

<p><font face="Times New Roman" size="2">^ направлением обмена (для
сплошного и изохронного об-<br>
менов).</font> </p>

<p><font face="Times New Roman" size="2">Каждое устройство
обязательно имеет конечную точку с но-<br>
мером 0, используемую для инициализации, общего
управ-<br>
ления и опроса его состояния. Эта точка всегда
сконфи-<br>
гурирована при включении питания и подключении<br>
устройства к шине. Оно поддерживает передачи
типа &quot;управ-<br>
ление&quot; (см. далее).</font> </p>

<p><font face="Times New Roman" size="2">Кроме нулевой точки,
устройства-функции могут иметь до-<br>
полнительные точки, реализующие полезный обмен
данны-<br>
ми. Низкоскоростные устройства могут иметь до
двух до-<br>
полнительных точек, полноскоростные - до 16 точек
ввода<br>
и 16 точек вывода (протокольное ограничение).
Точки не<br>
могут быть использованы до их конфигурирования
(уста-<br>
новления согласованного с ними канала).</font> </p>

<p><font face="Times New Roman" size="2"><i>Каналом {Pipe)</i> в USB
называется модель передачи данных<br>
между хост-контроллером и конечной точкой <i>(Endpoint)</i>
ус-<br>
тройства. Имеются два типа каналов: потоки <i>(Stream)</i>
и со-<br>
общения <i>(Message). Поток</i> доставляет данные от
одного конца<br>
канала к другому, он всегда однонаправленный.
Один и тот<br>
же номер конечной точки может использоваться для
двух<br>
поточных каналов - ввода и вывода. Поток может
реализо-<br>
вывать следующие типы обмена: сплошной,
изохронный и<br>
прерывания. Доставка всегда идет в порядке
&quot;первым во-<br>
шел - первым вышел&quot; (FIFO); с точки зрения USB,
данные<br>
потока неструктурированы. <i>Сообщения</i> имеют
формат, опре-<br>
деленный спецификацией USB. Хост посылает запрос к
ко-<br>
нечной точке, после которого передается
(принимается) па-<br>
кет сообщения, за которым следует пакет с
информацией<br>
состояния конечной точки. Последующее сообщение
нор-<br>
мально не может быть послано до обработки
предыдущего,<br>
но при отработке ошибок возможен сброс
необслуженных<br>
сообщений. Двухсторонний обмен сообщениями
адресуется<br>
к одной и той же конечной точке. Для доставки
сообщений<br>
используется только обмен типа
&quot;управление&quot;.</font> </p>

<p><font face="Times New Roman" size="2">С каналами связаны
характеристики, соответствующие конеч-<br>
ной точке (полоса пропускания, тип сервиса,
размер буфера</font> </p>

<hr>

<p><font face="Times New Roman" size="2">и т. п.). Каналы
организуются при конфигурировании уст-<br>
ройств USB. Для каждого включенного устройства
существует<br>
канал сообщений <i>(Control Pipe 0),</i> по которому
передается<br>
информация конфигурирования, управления и
состояния.</font> </p>

<p><font face="Times New Roman Narrow" size="2"><b>Типы передачи данных</b></font>
</p>

<p><font face="Times New Roman" size="2">USB поддерживает как
однонаправленные, так и двунаправ-<br>
ленные режимы связи. Передача данных
производится меж-<br>
ду ПО хоста и конечной точкой устройства.
Устройство мо-<br>
жет иметь несколько конечных точек, связь с
каждой из них<br>
(канал) устанавливается независимо.</font> </p>

<p><font face="Times New Roman" size="2">Архитектура USB допускает
четыре базовых типа передачи<br>
данных:</font> </p>

<p><font face="Times New Roman" size="2">^ <i>Управляющие посылки
(Control Transfers),</i> используемые для<br>
конфигурирования во время подключения и в
процессе<br>
работы для управления устройствами. Протокол
обеспе-<br>
чивает гарантированную доставку данных. Длина
поля<br>
данных управляющей посылки не превышает 64 байт
на<br>
полной скорости и 8 байт на низкой.</font> </p>

<p><font face="Times New Roman" size="2"><i>^ Сплошные передачи (Bulk Data
Transfers)</i> сравнительно<br>
больших пакетов без жестких требований ко
времени до-<br>
ставки. Передачи занимают всю свободную полосу
про-<br>
пускания шины. Пакеты имеют поле данных разме-<br>
ром 8, 16, 32 или 64 байт. Приоритет этих передач самый<br>
низкий, они могут приостанавливаться при большой
за-<br>
грузке шины. Допускаются только на полной
скорости<br>
передачи.</font> </p>

<p><font face="Times New Roman" size="2">йй <i>Прерывания (Interrupt) -</i>
короткие (до 64 байт на полной<br>
скорости, до 8 байт на низкой) передачи типа
вводимых<br>
символов или координат. Прерывания имеют
спонтанный<br>
характер и должны обслуживаться не медленнее,
чем того<br>
требует устройство. Предел времени обслуживания
уста-<br>
навливается в диапазоне 1-255 мс для полной
скорости<br>
и 10-255 мс - для низкой.</font> </p>

<p><font face="Times New Roman" size="2">^ <i>Изохронные передачи
(Isochronous Transfers) -</i> непрерыв-<br>
ные передачи в реальном времени, занимающие
предва-<br>
рительно согласованную часть пропускной
способности<br>
шины и имеющие заданную задержку доставки. В
случае</font> </p>

<hr>

<p><font face="Times New Roman" size="2">обнаружения ошибки
изохронные данные передаются без<br>
повтора - недействительные пакеты игнорируются.
При-<br>
мер - цифровая передача голоса. Пропускная
способность<br>
определяется требованиями к качеству передачи, а
задерж-<br>
ка доставки может быть критичной, например, при
реа-<br>
лизации телеконференций.</font> </p>

<p><font face="Times New Roman" size="2">Полоса пропускания шины
делится между всеми установ-<br>
ленными каналами. Выделенная полоса
закрепляется за ка-<br>
налом, и если установление нового канала требует
такой<br>
полосы, которая не вписывается в уже
существующее рас-<br>
пределение, запрос на выделение канала
отвергается.</font> </p>

<p><font face="Times New Roman" size="2">Архитектура US В
предусматривает внутреннюю буфериза-<br>
цию всех устройств, причем чем большей полосы
пропуска-<br>
ния требует устройство, тем больше должен быть
его буфер.<br>
USB должна обеспечивать обмен с такой скоростью,
чтобы<br>
задержка данных в устройстве, вызванная
буферизацией, не<br>
превышала нескольких миллисекунд.</font> </p>

<p><font face="Times New Roman" size="2">Изохронные передачи
классифицируются по способу син-<br>
хронизации конечных точек - источников или
получателей<br>
данных - с системой: различают асинхронньш,
синхронный<br>
и адаптивный классы устройств, каждому из
которых соот-<br>
ветствует свой тип канала USB.</font> </p>

<p><font face="Times New Roman" size="2"><b>Протокол</b></font> </p>

<p><font face="Times New Roman" size="2">Все обмены (транзакции) по
USB состоят из трех пакетов.<br>
Каждая <i>транзакция</i> планируется и начинается
по инициати-<br>
ве контроллера, который посылает <i>пакет-маркер
{Token<br>
Packet).</i> Он описывает тип и направление передачи,
адрес ус-<br>
тройства USB и номер конечной точки. В каждой
транзак-<br>
ции возможен обмен только между адресуемым
устройством<br>
(его конечной точкой) и хостом. Адресуемое
маркером уст-<br>
ройство распознает свой адрес и готовится к
обмену. Источ-<br>
ник данных (определенный маркером) передает
пакет данных<br>
(или уведомление об отсутствии данных,
предназначенных для<br>
передачи). После успешного приема пакета
приемник данных<br>
посылает <i>пакет подтверждения (Handshake Packet).</i></font> </p>

<p><font face="Times New Roman" size="2">Планирование транзакций
обеспечивает управление поточ-<br>
ными каналами. На аппаратном уровне
использование от-</font> </p>

<hr>

<p><font face="Times New Roman" size="2">каза от транзакции <i>(NAck)</i>
при недопустимой интенсивнос-<br>
ти передачи предохраняет буферы от переполнения
сверху<br>
и снизу. Маркеры отвергнутых транзакций повторно
пере-<br>
даются в свободное для шины время. Управление
потоками<br>
позволяет гибко планировать обслуживание
одновременных<br>
разнородных потоков данных.</font> </p>

<p><font face="Times New Roman" size="2"><i>Устойчивость к ошибкам</i>
обеспечивают следующие свойства<br>
USB:</font> </p>

<p><font face="Times New Roman" size="2">^ Высокое качество
сигналов, достигаемое благодаря диф-<br>
ференциальным приемникам/передатчикам и
экраниро-<br>
ванным кабелям.</font> </p>

<p><font face="Times New Roman" size="2">^ Защита полей управления и
данных CRC-кодами.</font> </p>

<p align="center"><font face="Times New Roman" size="2">^ Обнаружение
подключения и отключения устройств и<br>
конфигурирование ресурсов на системном уровне.</font>
</p>

<p><font face="Times New Roman" size="2">^ Самовосстановление
протокола с тайм-аутом при потере<br>
пакетов.</font> </p>

<p><font face="Times New Roman" size="2">^ Управление потоком для
обеспечения изохронности и<br>
управления аппаратными буферами.</font> </p>

<p><font face="Times New Roman" size="2">^ Независимость функций от
неудачных обменов с други-<br>
ми функциями.</font> </p>

<p><font face="Times New Roman" size="2">Для обнаружения ошибок
передачи каждый пакет имеет кон-<br>
трольные поля CRC-кодов, позволяющие обнаруживать
все<br>
одиночные и двойные битовые ошибки. Аппаратные
сред-<br>
ства обнаруживают ошибки передачи, а контроллер
автома-<br>
тически производит трехкратную попытку
передачи. Если<br>
повторы безуспешны, сообщение об ошибке
передается кли-<br>
ентскому ПО.</font> </p>

<p><font face="Times New Roman" size="2"><b>Форматы пакетов</b></font> </p>

<p><font face="Times New Roman" size="2">Байты передаются по шине
последовательно, начиная с млад-<br>
шего бита. Все посылки организованы в пакеты.
Каждый<br>
пакет начинается с поля синхронизации Sync,
которое пред-<br>
ставляется последовательностью состояний <i>KJKJKJKK</i>
(коди-<br>
рованную по NRZI), следующую после состояния <i>Idle.</i>
По-<br>
следние два бита <i>(КК)</i> являются маркером
начала пакета SOP,<br>
используемым для идентификации первого бита
идентифи-<br>
катора пакета <i>PID.</i> Идентификатор пакета
является 4-бит-</font> </p>

<hr>

<p><font face="Times New Roman" size="2">ным полем <i>PID[3:0],</i>
идентифицирующим тип пакета<br>
(табл. 7.2), за которым в качестве контрольных
следуют те<br>
же 4 бита, но инвертированные.</font> </p>

<table align="left" border="1">
  <tr>
    <td><font face="Times New Roman" size="2">Тип PID</font> </td>
    <td><font face="Times New Roman" size="2">Имя PID</font> </td>
    <td><font face="Times New Roman" size="2">PID[3:0]</font> </td>
    <td><font face="Times New Roman" size="2">Содержимое и назначение</font>
    </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2"><i>Token</i></font> </td>
    <td><font face="Times New Roman" size="2"><i>OUT</i></font> </td>
    <td><font face="Times New Roman" size="2">0001</font> </td>
    <td><font face="Times New Roman" size="2">Адрес функции и номер
    конечной<br>
    точки - маркер транзакции функ-<br>
    ции</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2"><i>Token</i></font> </td>
    <td><font face="Times New Roman" size="2"><i>IN</i></font> </td>
    <td><font face="Times New Roman" size="2">1001</font> </td>
    <td><font face="Times New Roman" size="2">Адрес функции и номер
    конечной<br>
    точки - маркер транзакции хоста</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2"><i>Token</i></font> </td>
    <td><font face="Times New Roman" size="2"><i>SOF</i></font> </td>
    <td><font face="Times New Roman" size="2">0101</font> </td>
    <td><font face="Times New Roman" size="2">Маркер начала кадра</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2"><i>Token</i></font> </td>
    <td><font face="Times New Roman" size="2"><i>SETUP</i></font> </td>
    <td><font face="Times New Roman" size="2">1101</font> </td>
    <td><font face="Times New Roman" size="2">Адрес функции и номер
    конечной<br>
    точки - маркер транзакции с управ-<br>
    ляющей точкой</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2"><i>Data</i></font> </td>
    <td><font face="Times New Roman" size="2"><i>DataO<br>
    Datal</i></font> </td>
    <td><font face="Times New Roman" size="2">0011<br>
    1011</font> </td>
    <td><font face="Times New Roman" size="2">Пакеты данных с четным<br>
    и нечетным PID чередуются<br>
    для точной идентификации под-<br>
    тверждений</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2"><i>Handshake</i></font> </td>
    <td><font face="Times New Roman" size="2"><i>Ack</i></font> </td>
    <td><font face="Times New Roman" size="2">0010</font> </td>
    <td><font face="Times New Roman" size="2">Подтверждение
    безошибочного<br>
    приема пакета</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2"><i>Handshake</i></font> </td>
    <td><font face="Times New Roman" size="2"><i>NAK</i></font> </td>
    <td><font face="Times New Roman" size="2">1010</font> </td>
    <td><font face="Times New Roman" size="2">Приемник не сумел принять
    или<br>
    передатчик не сумел передать<br>
    данные. Может использоваться для<br>
    управления потоком данных<br>
    (неготовность). В транзакциях пре-<br>
    рываний является признаком<br>
    отсутствия необслуженных преры-<br>
    ваний</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2"><i>Handshake</i></font> </td>
    <td><font face="Times New Roman" size="2"><i>STALL</i></font> </td>
    <td><font face="Times New Roman" size="2">1110</font> </td>
    <td><font face="Times New Roman" size="2">Конечная точка требует
    вмеша-<br>
    тельства хоста</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2"><i>Special</i></font> </td>
    <td><font face="Times New Roman" size="2"><i>PRE</i></font> </td>
    <td><font face="Times New Roman" size="2">1100</font> </td>
    <td><font face="Times New Roman" size="2">Преамбула передачи на
    низкой<br>
    скорости</font> </td>
  </tr>
</table>

<p><br clear="all">
</p>

<p><font face="Times New Roman" size="2">В пакетах-маркерах <i>IN, SETUP</i>
и <i>OUT</i> следующими являются<br>
<i>адресные поля:</i> 7-битный адрес функции и
4-битный адрес<br>
конечной точки. Они позволяют адресовать до 127
функций<br>
USB (нулевой адрес используется для
конфигурирования)<br>
и по 16 конечных точек в каждой функции.</font> </p>

<hr>

<p><font face="Times New Roman" size="2">В пакете SOF имеется
11-битное <i>поле номера кадра (Frame<br>
Number Field),</i> последовательно (циклически)
увеличиваемое<br>
для очередного кадра.</font> </p>

<p><font face="Times New Roman" size="2"><i>Поле данных</i> может
иметь размер от 0 до 1023 целых байт.<br>
Размер поля зависит от типа передачи и
согласуется при<br>
установлении канала.</font> </p>

<p><font face="Times New Roman" size="2"><i>Поле СКС-кола</i>
присутствует во всех маркерах и пакетах дан-<br>
ных, оно защищает все поля пакета, исключая <i>PID.</i>
CRC для<br>
маркеров (5 бит) и данных (11 бит) подсчитываются по
раз-<br>
ным формулам.</font> </p>

<p><font face="Times New Roman" size="2">Каждая транзакция
инициируется хост-контроллером посыл-<br>
кой маркера и завершается пакетом квитирования.
После-<br>
довательность пакетов в транзакциях
иллюстрирует рис. 7.7.</font> </p>

<p><font face="Times New Roman" size="2">Хост-контроллер
организует обмены с устройствами согласно<br>
своему плану распределения ресурсов. Контроллер
цикли-<br>
чески (с периодом 1 мс) формирует <i>кадры (Frames),</i> в
кото-<br>
рые укладываются все запланированные
транзакции. Каж-<br>
дый кадр начинается с посылки маркера SOF <i>(Start Of
Frame),<br>
</i>который является синхронизирующим сигналом
для всех<br>
устройств, включая хабы. В конце каждого кадра
выделяет-<br>
ся интервал времени <i>EOF (End Of Frame),</i> на время
которого<br>
хабы запрещают передачу по направлению к
контроллеру.<br>
Каждый кадр имеет свой номер. Хост-контроллер
опериру-<br>
ет 32-битным счетчиком, но в маркере SOF передает
только<br>
младшие 11 бит. Номер кадра увеличивается
(циклически)<br>
во время EOF. Хост планирует загрузку кадров так,
чтобы в<br>
них всегда находилось место для транзакций
управления и<br>
прерывания. Свободное время кадров может
заполняться<br>
сплошными передачами <i>(Bulk Transfers).</i></font> </p>

<p><img border="0" vspace="3" hspace="3" src="75.jpg" alt="75.jpg" width="708"
height="328"> <br clear="all">
</p>

<hr>

<p><img border="0" vspace="3" hspace="3" src="76.jpg" alt="76.jpg" width="848"
height="164"> <br clear="all">
</p>

<p align="center"><font face="Times New Roman" size="2"><b>Рис. 7.8.</b> Поток
кадров USB</font> </p>

<p><font face="Times New Roman" size="2">Для <i>изохронной передачи</i>
важна синхронизация устройств и<br>
контроллера. Есть три варианта:</font> </p>

<p><font face="Times New Roman" size="2">^ синхронизация
внутреннего генератора устройства с мар-<br>
керами SOF;</font> </p>

<p><font face="Times New Roman" size="2">^ подстройка частоты
кадров под частоту устройства;</font> </p>

<p><font face="Times New Roman" size="2">^ согласование скорости
передачи (приема) устройства с<br>
частотой кадров.</font> </p>

<p><font face="Times New Roman" size="2">Подстройка частоты кадров
контроллера возможна, есте-<br>
ственно, под частоту внутренней синхронизации
только од-<br>
ного устройства. Подстройка осуществляется
через механизм<br>
обратной связи, который позволяет изменять
период кадра<br>
в пределах ±1 битового интервала.</font> </p>

<p><font face="Times New Roman" size="3"><b>7.1.2. Системное
конфигурирование</b></font> </p>

<p><font face="Times New Roman" size="2">USB поддерживает
динамическое подключение и отключе-<br>
ние устройств. Нумерация устройств шины является
посто-<br>
янным процессом, отслеживающим изменения
физической<br>
топологии.</font> </p>

<p><font face="Times New Roman" size="2">Все устройства
подключаются через порты хабов. Хабы<br>
определяют подключение и отключение устройств к
своим<br>
портам и сообщают состояние портов при запросе
от кон-<br>
троллера. Хост разрешает работу порта и
адресуется к уст-<br>
ройству через канал управления, используя <i>нулевой
адрес -<br>
USB Default Address.</i> При начальном подключении или пос-<br>
ле сброса все устройства адресуются именно так.</font>
</p>

<p><font face="Times New Roman" size="2">Хост определяет, является
новое подключенное устройство<br>
хабом или функцией, и назначает ему <i>уникальный
адрес</i> USB.<br>
Хост создает канал управления <i>(Control Pipe) с</i> этим
устрой-<br>
ством, используя назначенный адрес и нулевой
номер точки<br>
назначения.</font> </p>

<p><font face="Times New Roman" size="2">Если новое устройство
является хабом, хост определяет под-<br>
ключенные к нему устройства, назначает им адреса
и уста-</font> </p>

<hr>

<p><font face="Times New Roman" size="2">навливает каналы. Если
новое устройство является функ-<br>
цией, уведомление о подключении передается
диспетчером<br>
USB заинтересованному ПО.</font> </p>

<p><font face="Times New Roman" size="2">Когда устройство
отключается, хаб автоматически запреща-<br>
ет соответствующий порт и сообщает об отключении
кон-<br>
троллеру, который удаляет сведения о данном
устройстве из<br>
всех структур данных. Если отключается хаб,
процесс уда-<br>
ления выполняется для всех подключенных к нему
устройств.<br>
Если отключается функция, уведомление
посылается заин-<br>
тересованному ПО.</font> </p>

<p><font face="Times New Roman" size="2"><i>Нумерация устройств,</i>
подключенных к шине <i>(Bus<br>
Enumeration),</i> осуществляется динамически по мере их
под-<br>
ключения (или включения их питания) без
какого-либо вме-<br>
шательства пользователя или клиентского ПО.
Процедура<br>
нумерации выполняется следующим образом:</font> </p>

<p><font face="Times New Roman" size="2">1. Хаб, к которому
подключилось устройство, информиру-<br>
ет хост о смене состояния своего порта ответом на
опрос<br>
состояния. С этого момента устройство переходит
в со-<br>
стояние <i>Attached</i> (подключено), а порт, к которому
оно<br>
подключилось, в состояние <i>Disabled.</i></font> </p>

<p><font face="Times New Roman" size="2">2. Хост уточняет состояние
порта.</font> </p>

<p><font face="Times New Roman" size="2">3. Узнав порт, к которому
подключилось новое устройство,<br>
хост дает команду сброса и разрешения порта.</font> </p>

<p><font face="Times New Roman" size="2">4. Хаб формирует сигнал Reset
для данного порта (10 мс)<br>
и переводит его в состояние <i>Enabled.</i>
Подключенное<br>
устройство может потреблять от шины ток питания<br>
до 100 мА. Устройство переходит в состояние <i>Powered</i>
(пи-<br>
тание подано), все его регистры переводятся в
исходное<br>
состояние, и оно отзывается на обращение по
нулевому<br>
адресу.</font> </p>

<p><font face="Times New Roman" size="2">5. Пока устройство не
получит уникальный адрес, оно до-<br>
ступно по дежурному каналу, по которому
хост-контрол-<br>
лер определяет максимально допустимый размер
поля<br>
данных пакета.</font> </p>

<p><font face="Times New Roman" size="2">6. Хост сообщает устройству
его уникальный адрес, и оно<br>
переводится в состояние <i>Addressed</i> (адресовано).</font>
</p>

<hr>

<p><font face="Times New Roman" size="2">7. Хост считывает
конфигурацию устройства, включая за-<br>
явленный потребляемый ток от шины. Считывание мо-<br>
жет затянуться на несколько кадров.</font> </p>

<p><font face="Times New Roman" size="2">8. Исходя из полученной
информации, хост конфигуриру-<br>
ет все имеющиеся конечные точки данного
устройства,<br>
которое переводится в состояние <i>Configured</i>
(сконфигу-<br>
рировано). Теперь хаб позволяет устройству
потреблять<br>
от шины полный ток, заявленный в конфигурации.
Уст-<br>
ройство готово.</font> </p>

<p><font face="Times New Roman" size="2">Когда устройство
отключается от шины, хаб уведомляет об<br>
этом хост и работа порта запрещается, а хост
обновляет свою<br>
текущую топологическую информацию.</font> </p>

<p><font face="Times New Roman" size="3"><b>7.1.3. Устройства USB -
функции и хабы</b></font> </p>

<p><font face="Times New Roman" size="2">Возможности шины USB
позволяют использовать ее для<br>
подключения разнообразных устройств. Не касаясь
&quot;полез-<br>
ных&quot; свойств ПУ, остановимся на их
интерфейсной части,<br>
связанной с шиной USB. Все устройства должны
поддержи-<br>
вать набор общих операций, перечисленных ниже.</font>
</p>

<p><font face="Times New Roman" size="2"><i>Динамическое
подключение и отключение.</i> Эти события от-<br>
слеживаются хабом, который сообщает о них
хост-контрол-<br>
леру и выполняет сброс подключенного устройства.
Устрой-<br>
ство после сигнала сброса должно отзываться на
нулевой<br>
адрес, при этом оно не сконфигурировано и не
приостанов-<br>
лено. После назначения адреса, за которое
отвечает хост-кон-<br>
троллер, устройство должно отзываться только на
свой уни-<br>
кальный адрес.</font> </p>

<p><font face="Times New Roman" size="2"><i>Конфигурирование</i>
устройств, выполняемое хостом, являет-<br>
ся необходимым для их использования. Для
конфигуриро-<br>
вания обычно используется информация, считанная
из<br>
самого устройства. Устройство может иметь
множество ин-<br>
терфейсов, каждому из которых соответствует
собственная<br>
конечная точка, представляющая хосту функцию
устройства.<br>
Интерфейс в конфигурации может иметь
альтернативные<br>
наборы характеристик; смена наборов
поддерживается про-<br>
токолом. Для поддержки адаптивных драйверов
дескрипто-<br>
ры устройств и интерфейсов имеют поля класса,
подкласса<br>
и протокола.</font> </p>

<hr>

<p><font face="Times New Roman" size="2"><i>Передача данных</i>
возможна посредством одного из четырех<br>
типов передач (см. выше). Для конечных точек,
допускаю-<br>
щих разные типы передач, после конфигурирования
досту-<br>
пен только один из них.</font> </p>

<p><font face="Times New Roman" size="2"><i>Управление
энергопотреблением</i> является весьма развитой<br>
функцией USB. Для устройств, питающихся от шины,
мощ-<br>
ность ограничена. Любое устройство при
подключении не<br>
должно потреблять от шины ток, превышающий 100 мА.<br>
Рабочий ток (не более 500 мА) заявляется в
конфигурации,<br>
и если хаб не сможет обеспечить устройству
заявленный ток,<br>
оно не конфигурируется и, следовательно, не может
быть<br>
использовано.</font> </p>

<p><font face="Times New Roman" size="2">Устройство USB должно
поддерживать <i>приостановку<br>
(Suspended Mode),</i> в котором его потребляемый ток не
пре-<br>
вышает 500 мкА. Устройство должно автоматически
приос-<br>
танавливаться при прекращении активности шины.</font>
</p>

<p><font face="Times New Roman" size="2">Возможность <i>удаленного
пробуждения (Remote Wakeup)</i> по-<br>
зволяет приостановленному устройству подать
сигнал хост-<br>
компьютеру, который тоже может находиться в
приостанов-<br>
ленном состоянии. Возможность удаленного
пробуждения<br>
описывается в конфигурации устройства. При
конфигури-<br>
ровании эта функция может быть запрещена.</font> </p>

<p><font face="Times New Roman" size="2"><i>Хаб</i> в USB выполняет
коммутацию сигналов и выдачу пи-<br>
тающего напряжения, а также отслеживает
состояние под-<br>
ключенных к нему устройств, уведомляя хост об
изменени-<br>
ях. Хаб состоит из двух частей - контроллера <i>(Hub
Controller)<br>
</i>и повторителя <i>(Hub Repeater). Повторитель</i>
представляет<br>
собой управляемый ключ, соединяющий выходной
порт со<br>
входным. Он имеет средства поддержки сброса и
приоста-<br>
новки передачи сигналов. <i>Контроллер</i> содержит
регистры для<br>
взаимодействия с хостом. Доступ к регистрам
осуществля-<br>
ется по специфическим командам обращения к хабу.
Коман-<br>
ды позволяют конфигурировать хаб, управлять
нисходящи-<br>
ми портами и наблюдать их состояние.</font> </p>

<p><font face="Times New Roman" size="2"><i>Нисходящие (Downstream) порты</i>
хабов могут находиться в<br>
следующих состояниях:</font> </p>

<p><font face="Times New Roman" size="2">^ <i>Powered</i> (^(питание
отключено) - на порт не подается<br>
питание (возможно только для хабов,
коммутирующих</font> </p>

<hr>

<p><font face="Times New Roman" size="2">питание). Выходные буферы
переводятся в высокоимпе-<br>
дансное состояние, входные сигналы игнорируются.</font>
</p>

<p><font face="Times New Roman" size="2">^ <i>Disconnected</i> (отсоединен) -
порт не передает сигналы ни<br>
в одном направлении, но способен обнаружить
подключе-<br>
ние устройства (по отсутствию состояния <i>SEO</i> в
течение<br>
2,5 мкс). Тогда порт переходит в состояние <i>Disabled,</i>
а по<br>
уровням входных сигналов <i>{DiffO</i> или <i>Diff1</i> в
состоянии<br>
<i>Idle)</i> он определяет скорость подключенного
устройства.</font> </p>

<p><font face="Times New Roman" size="2">s^ <i>Disabled</i> (запрещен) - порт
передает только сигнал сбро-<br>
са (по команде от контроллера), сигналы от порта
(кро-<br>
ме обнаружения отключения) не воспринимаются. По<br>
обнаружении отключения (2,5 мкс состояния <i>SEO)</i>
порт<br>
переходит в состояние <i>Disconnect,</i> а если
отключение об-<br>
наружено &quot;спящим&quot; хабом, контроллеру будет
послан<br>
сигнал <i>Resume.</i></font> </p>

<p><font face="Times New Roman" size="2"><i>ш Enabled</i> (разрешен) - порт
передает сигналы в обоих на-<br>
правлениях. По команде контроллера или по
обнаруже-<br>
нии ошибки кадра порт переходит в состояние <i>Disabled,<br>
</i>а по обнаружении отключения - в состояние <i>Disconnect.</i></font>
</p>

<p><font face="Times New Roman" size="2"><i>^ Suspended</i> (приостановлен) -
порт передает сигнал пере-<br>
вода в состояние останова (&quot;спящий&quot; режим).
Если хаб<br>
находится в активном состоянии, сигналы через
порт не<br>
пропускаются ни в одном направлении. Однако
&quot;спящий&quot;<br>
хаб воспринимает сигналы смены состояния
незапрещен-<br>
ных портов, подавая &quot;пробуждающие&quot; сигналы
от акти-<br>
визировавшегося устройства даже через цепочку
&quot;спя-<br>
щих&quot; хабов.</font> </p>

<p><font face="Times New Roman" size="2">Состояние каждого порта
идентифицируется контроллером<br>
хаба с помощью отдельных регистров. Имеется
общий ре-<br>
гистр, биты которого отражают факт изменения
состояния<br>
каждого порта (фиксируемый во время <i>EOF).</i> Это
позволяет<br>
хост-контроллеру быстро узнать состояние хаба, а
в случае<br>
обнаружения изменений специальными
транзакциями уточ-<br>
нить состояние.</font> </p>

<p><font face="Times New Roman" size="3"><b>7.1.4. Хост-контроллер</b></font>
</p>

<p><font face="Times New Roman" size="2">Хост-компьютер общается с
устройствами через контроллер.<br>
Хост имеет следующие обязанности:</font> </p>

<hr>

<p><font face="Times New Roman" size="2">^ обнаружение подключения
и отсоединения устройств<br>
USB;</font> </p>

<p><font face="Times New Roman" size="2">^ манипулирование потоком
управления между устройства-<br>
ми и хостом;</font> </p>

<p><font face="Times New Roman" size="2">^ управление потоками
данных;</font> </p>

<p><font face="Times New Roman" size="2">^ сбор статистики;</font> </p>

<p><font face="Times New Roman" size="2">^ обеспечение
энергосбережения подключенными ПУ.</font> </p>

<p><font face="Times New Roman" size="2">Системное ПО контроллера
управляет взаимодействием меж-<br>
ду устройствами и их ПО, функционирующим на
хост-ком-<br>
пьютере, для согласования:</font> </p>

<p><font face="Times New Roman" size="2">^ нумерации и конфигурации
устройств;</font> </p>

<p><font face="Times New Roman" size="2">^ изохронных передач
данных;</font> </p>

<p><font face="Times New Roman" size="2">^ асинхронных передач
данных;</font> </p>

<p><font face="Times New Roman" size="2">^ управления
энергопотреблением;</font> </p>

<p><font face="Times New Roman" size="2">^ информации об управлении
устройствами и шиной.</font> </p>

<p><font face="Times New Roman" size="2">По возможности ПО USB
использует существующее систем-<br>
ное ПО хост-компьютера - например, Advanced Power<br>
Management для управления энергопотреблением.</font> </p>

<p><font face="Times New Roman" size="4"><b>7.2. Шина IEEE 1394-FireWire</b></font> </p>

<p><font face="Times New Roman" size="2">Стандарт для
высокопроизводительной последовательной<br>
шины (High Performance Serial Bus), получивший офици-<br>
альное название IEEE 1394, был принят в 1995 году. Целью<br>
являлось создание шины, не уступающей
современным стан-<br>
дартным параллельным шинам, при существенном
удешев-<br>
лении и повышении удобства подключения (за счет
перехо-<br>
да на последовательный интерфейс). Стандарт
основан на<br>
шине <i>FireWire,</i> используемой Apple Computer в качестве
де-<br>
шевой альтернативы SCSI в компьютерах Macintosh и<br>
PowerMac. Название FireWire (&quot;огненный провод&quot;)
теперь<br>
применяется и к реализациям IEEE 1394, оно
сосуществует<br>
с кратким обозначением <i>1394.</i></font> </p>

<p><font face="Times New Roman" size="2"><i>Преимущества FireWire</i>
перед другими последовательными<br>
шинами:</font> </p>

<hr>

<p><font face="Times New Roman" size="2">s? Многофункциональность:
шина обеспечивает цифровую<br>
связь до 63 устройств без применения
дополнительной<br>
аппаратуры (хабов). Устройства - цифровые
камкодеры,<br>
сканеры, принтеры, камеры для видеоконференций,
дис-<br>
ковые накопители - могут обмениваться данными не<br>
только с PC, но и между собой. FireWire по инициативе<br>
VESA позиционируется и для &quot;домашних сетей&quot;.</font>
</p>

<p><font face="Times New Roman" size="2"><i>^</i> Высокая скорость
обмена и изохронные передачи позво-<br>
ляют даже на начальном уровне (100 Мбит/с)
передавать<br>
одновременно два канала видео (30 кадров в
секунду)<br>
широковещательного качества и
стереоаудиосигнал с ка-<br>
чеством CD.</font> </p>

<p><font face="Times New Roman" size="2">s§ Низкая цена компонентов
и кабеля.</font> </p>

<p><font face="Times New Roman" size="2">si Легкость установки и
использования. FireWire расши-<br>
ряет систему РпР. Устройства автоматически
распозна-<br>
ются и конфигурируются при включении/отключении.<br>
Питание от шины (ток до 1,5 А) позволяет ПУ общать-<br>
ся с системой даже при отключении их питания.
Управ-<br>
лять шиной и другими устройствами могут не
только<br>
PC, но и другие &quot;интеллектуальные&quot;
устройства, напри-<br>
мер VCR.</font> </p>

<p><font face="Times New Roman" size="3"><b>7.2.1. Структура и
взаимодействие устройств шины</b></font> </p>

<p><font face="Times New Roman" size="2">Стандарт 1394 определяет две
категории шин: кабельные<br>
шины и кросс-шины <i>(Backplane).</i> Под <i>кросс-шинами</i>
обычно<br>
подразумеваются параллельные интерфейсы,
объединяющие<br>
внутренние подсистемы устройства, подключенного
к<br>
кабелю 1394.</font> </p>

<p><font face="Times New Roman" size="2">В отличие от USB,
управляемой одним хост-контроллером,<br>
стандарт 1394 допускает соединение равноправных
устройств<br>
в сеть. Сеть может состоять из множества шин,
соединенных<br>
мостами. В пределах одной шины устройства
объединяются<br>
соединительными кабелями без применения
дополнительных<br>
устройств. <i>Мосты</i> представляют собой
специальные интел-<br>
лектуальные устройства. Интерфейсная карта шины
FireWire<br>
для PC представляет собой мост PCI - 1394. Мостами яв-<br>
ляются также соединения кабельной шины 1394 с
кросс-<br>
шинами устройств, 16-битная адресация узлов сети
допус-</font> </p>

<hr>

<p><font face="Times New Roman" size="2">кает до 63 устройств в
каждой шине, адресуемых 6-битным<br>
полем идентификатора узла. 10-битное поле
идентификато-<br>
ра шины допускает использование в системе до 1023
мос-<br>
тов, соединяющих шины разного типа.</font> </p>

<p><font face="Times New Roman" size="2"><i>Кабельная шина</i>
представляет собой сеть, состоящую из уз-<br>
лов и кабельных мостов. Гибкая топология
позволяет стро-<br>
ить сети, сочетающие древовидную и цепочечную ар-<br>
хитектуры (рис. 7.9). Каждый узел обычно имеет три<br>
равноправных соединительных разъема.
Допускается мно-<br>
жество вариантов подключения устройств со
следующими<br>
ограничениями:</font> </p>

<p align="center"><font face="Times New Roman" size="2">ssi между любой
парой узлов может быть не более 16 ка-<br>
бельных сегментов;</font> </p>

<p align="center"><font face="Times New Roman" size="2">^ длина сегмента
стандартного кабеля не должна превы-<br>
шать 4,5 м;</font> </p>

<p><font face="Times New Roman" size="2">2Й суммарная длина кабеля
не должна превышать 72 м (при-<br>
менение более качественного кабеля позволяет
ослабить<br>
это ограничение).</font> </p>

<p><font face="Times New Roman" size="2">Некоторые устройства
могут иметь только один разъем, что<br>
ограничивает возможные варианты их
местоположения.<br>
Стандарт допускает до 27 разъемов на одном
устройстве.</font> </p>

<p><img border="0" vspace="3" hspace="3" src="77.jpg" alt="77.jpg" width="896"
height="496"> <br clear="all">
</p>

<p align="center"><font face="Times New Roman" size="2"><b>Рис. 7.9.</b>
Соединение устройств на шине FireWire</font> </p>

<hr>

<p><img border="0" vspace="3" hspace="3" src="78.jpg" alt="78.jpg" width="718"
height="236"> <br clear="all">
</p>

<p align="center"><font face="Times New Roman" size="2"><b>Рис. 7.10.</b> Разъем
FireWire</font> </p>

<p><font face="Times New Roman" size="2">Стандарт предусматривает
связь узлов с помощью 6-провод-<br>
ного кабеля, заключенного в общий экран. Две
витые пары<br>
используются для передачи сигналов (раздельные
для при-<br>
емника и передатчика), два провода задействованы
для пи-<br>
тания устройств (8-40 В, до 1,5 А). Для гальванической<br>
развязки интерфейса используются
трансформаторы (напря-<br>
жение изоляции развязки до 500 В) или конденсаторы
(в<br>
дешевых устройствах с напряжением развязки до 60
В от-<br>
носительно общего провода). Представление о
разъемах дает<br>
рис. 7.10. Некоторые устройства (камкодеры Sony DCR-<br>
VX700 и DCR-VX1000, а также DHR-1000 DVCR) имеют<br>
только один 4-контактный разъем меньшего размера,
у ко-<br>
торого реализованы только сигнальные цепи. Эти
устрой-<br>
ства подключаются к шине через специальный
переходной<br>
кабель только как оконечные (хотя возможно
применение<br>
специальных адаптеров-разветвителей).</font> </p>

<p><font face="Times New Roman" size="2">Стандарт 1394 определяет три
возможные частоты переда-<br>
чи сигналов по кабелям: 98,304, 196,608 и 393,216 Мбит/с,<br>
которые округляют до 100, 200 и 400 Мбит/с. Частоты в<br>
стандарте обозначаются как <i>S100, S200</i> и <i>S400</i>
соответствен-<br>
но. Бытовые устройства обычно поддерживают <i>S100,</i>
боль-<br>
шинство адаптеров допускают <i>S200.</i> К одной шине
могут<br>
подключаться устройства, рассчитанные на разные
скорос-<br>
ти. Обмен будет происходить на минимальной для
всех ак-<br>
тивных узлов скорости. Однако, если
хост-контроллер реа-<br>
лизует карту топологии и скоростей <i>(Topology_Мар</i>
и<br>
<i>Speed_Map),</i> возможно использование нескольких
частот в<br>
одной шине, в соответствии с возможностями
конкретной<br>
пары, участвующей в обмене.</font> </p>

<p><font face="Times New Roman" size="2">Система допускает
динамическое (горячее) подключение и<br>
отключение устройств. Идентификаторы
подключаемым</font> </p>

<hr>

<p><font face="Times New Roman" size="2">устройствам назначаются
автоматически, без участия пользо-<br>
вателя. Изменения топологии (состава
подключенных уст-<br>
ройств) автоматически отслеживаются шиной и
передаются<br>
управляющему ПО.</font> </p>

<p><font face="Times New Roman" size="2"><b>Протокол IEEE 1394</b></font> </p>

<p><font face="Times New Roman" size="2">Протокол 1394 реализуется на
трех уровнях (рис. 7.11).</font> </p>

<p><font face="Times New Roman" size="2">^ <i>Уровень транзакций
(Transaction Layer)</i> преобразует па-<br>
кеты в данные, предоставляемые приложениям, и
наобо-<br>
рот. Он реализует протокол запросов-ответов,
соответству-<br>
ющий стандарту ISO/IEC 13213:1994 (ANSI/IEEE 1212,<br>
редакции 1994 г.), архитектуры регистров управления
и<br>
состояния CSR (Control and Status Register) для микро-<br>
компьютерных шин (чтение, запись, блокировка). Это<br>
облегчает связь шины 1394 со стандартными
параллель-<br>
ными шинами.</font> </p>

<p><font face="Times New Roman" size="2">^ <i>Уровень связи (Link Layer)</i>
из данных физического уров-<br>
ня формирует пакеты и выполняет обратные
преобразо-<br>
вания. Он обеспечивает обмен узлов датаграммами
с под-<br>
тверждениями. Уровень отвечает за передачу
пакетов и<br>
управление изохронными передачами.</font> </p>

<p><font face="Times New Roman" size="2">^ <i>Физический уровень
(Physical Layer)</i> вырабатывает и при-<br>
нимает сигналы шины. Он обеспечивает
инициализацию<br>
и арбитраж, предполагая, что в любой момент
времени<br>
работает только один передатчик. Уровень
передает по-<br>
токи данных и уровни сигналов последовательной
шины<br>
вышестоящему уровню. Между этими уровнями
возмож-<br>
на гальваническая развязка, при которой
микросхемы<br>
физического уровня питаются от шины.
Гальваническая<br>
развязка необходима для предотвращения
паразитных<br>
контуров общего провода, которые могут появиться
че-<br>
рез провода защитного заземления блоков питания.</font>
</p>

<p><font face="Times New Roman" size="2">Аппаратная часть FireWire
обычно состоит из двух специ-<br>
ализированных микросхем - трансиверов
физического<br>
уровня <i>PHY Transceiver</i> и моста связи с шиной <i>LINK Chip.<br>
</i>Связь между ними возможна, например, по
интерфейсу<br>
IBM-Apple LINK-PHY. Микросхемы уровня связи выпол-<br>
няют все функции своего уровня и часть функций
уровня</font> </p>

<hr>

<p><font face="Times New Roman" size="2">транзакций, остальная
часть уровня транзакций выполня-<br>
ется программно.</font> </p>

<p><img border="0" vspace="3" hspace="3" src="79.jpg" alt="79.jpg" width="804"
height="700"> <br clear="all">
</p>

<p><font face="Times New Roman" size="1">Коннекторы</font> </p>

<p align="center"><font face="Times New Roman" size="2"><b>Рис. 7.11.</b>
Трехуровневая структура FireWire</font> </p>

<p><font face="Times New Roman" size="2">Управление шиной</font> </p>

<p><font face="Times New Roman" size="2">Протокол 1394 имеет гибкий
механизм управления связью<br>
между различными устройствами. Для этого не
обязательно<br>
присутствие на шине PC или иного контроллера шины.<br>
Управление включает три сервиса:</font> </p>

<p><font face="Times New Roman" size="2">^ <i>Мастер циклов,</i>
посылающий широковещательные паке-<br>
ты начала циклов (требуемые для изохронных
обменов).</font> </p>

<p><font face="Times New Roman" size="2">^ <i>Диспетчер изохронных
ресурсов,</i> если какой-либо узел<br>
поддерживает изохронный обмен (для цифрового
видео<br>
и аудио).</font> </p>

<p><font face="Times New Roman" size="2">^ <i>Необязательный
контроллер шины (Bus Master) -</i> им мо-<br>
жет являться PC или редактирующий DVCR.</font> </p>

<hr>

<p><font face="Times New Roman" size="2">По сбросу производится
определение структуры шины, каж-<br>
дому узлу назначаются физические адреса и
производится<br>
арбитраж мастера циклов, диспетчера изохронных
ресурсов<br>
и контроллера шины. Через секунду после сброса
все ресур-<br>
сы становятся доступными для последующего
использования.</font> </p>

<p><font face="Times New Roman" size="2">Принципиальным
преимуществом шины является отсутствие<br>
необходимости в контроллере. Любое передающее
устрой-<br>
ство может получить полосу изохронного трафика и
начи-<br>
нать передачу по сигналу автономного или
дистанционного<br>
управления - приемник &quot;услышит&quot; эту
информацию. При<br>
наличии контроллера (PC) соответствующее ПО может<br>
управлять работой устройств, реализуя, например,
цифро-<br>
вую студию нелинейного видеомонтажа.</font> </p>

<p><font face="Times New Roman" size="2"><b>Изохронная
транспортировка данных</b></font> </p>

<p><font face="Times New Roman" size="2">Изохронная
транспортировка шины 1394 обеспечивает гаран-<br>
тированную пропускную способность и
ограниченную задерж-<br>
ку при высокоскоростной передаче по множеству
каналов.<br>
Диспетчер изохронных ресурсов содержит регистр<br>
<i>BANDWIDTH^AVAILABLE,</i> который определяет доступность<br>
оставшейся части полосы пропускания для узлов с
изохрон-<br>
ной передачей. По сбросу вновь появившийся узел с
изо-<br>
хронной передачей запрашивает выделение полосы.
Для циф-<br>
рового видео, например, требуется полоса 30 Мбит/с<br>
(25 Мбит/с на видеоданные и 3-4 Мбит/с на аудио, син-<br>
хронизацию и заголовки пакетов). Полоса
измеряется в спе-<br>
циальных единицах распределения, число которых в
125-мил-<br>
лисекундном цикле составляет 6144. Единица
занимает около<br>
20 нс, что соответствует времени, требуемому для
передачи<br>
одного <i>квадлета</i> (Quadlet) на частоте 1600 Мбит/с. <i>Квадлет<br>
</i>(32-битное слово) является единицей передачи
данных по<br>
шине. 25 мс цикла резервируется под асинхронный
трафик,<br>
поэтому начальное значение регистра после
сброса состав-<br>
ляет 4915 единиц. В <i>S100</i> устройства цифрового
видео за-<br>
прашивают около 1800 единиц, в <i>S200 -</i> около 900. Если
со-<br>
ответствующая полоса недоступна, запрашивающее
ее<br>
устройство будет периодически повторять запрос.</font>
</p>

<p><font face="Times New Roman" size="2">Диспетчер изохронных
ресурсов каждому изохронному узлу<br>
назначает номер канала (0-63) из числа доступных
(регистр</font> </p>

<hr>

<p><font face="Times New Roman" size="2"><i>CHANNELS_AVAILABLE).</i> Он является
идентификатором изо-<br>
хронного пакета. Когда изохронный обмен
становится не-<br>
нужным узлу, он должен освободить свою полосу и
номер<br>
канала. Обмен управляющей информацией
производится по<br>
асинхронному каналу.</font> </p>

<p><font face="Times New Roman" size="3"><b>7.2.2. Синонимы и
дополнения стандарта IEEE 1394</b></font> </p>

<p><font face="Times New Roman" size="2">Шина IEEE 1394 имеет множество
псевдонимов:</font> </p>

<p><font face="Times New Roman" size="2">^ IEEE 1394-1995 Standard for a High Performance
Serial<br>
Bus - полное название документа, описывающего стан-<br>
дарт, действующий в настоящее время.</font> </p>

<p><font face="Times New Roman" size="2"><i>т</i> FireWire - торговая марка
реализации IEEE-1394 фир-<br>
мой Apple Computer, Inc.</font> </p>

<p><font face="Times New Roman" size="2">^ Р1394 - название
предварительной версии IEEE-1394<br>
(до принятия в декабре 1995 г.).</font> </p>

<p><font face="Times New Roman" size="2">^ DigitalLink - торговая марка Sony
Corporation, исполь-<br>
зуемая применительно к реализации IEEE-1394 в циф-<br>
ровых камерах.</font> </p>

<p><font face="Times New Roman" size="2"><i>ш</i> MultiMedia Connection - имя,
используемое в логоти-<br>
пе 1394 High Performance Serial Bus Trade Association<br>
(1394TA).</font> </p>

<p><font face="Times New Roman" size="2">Поскольку фирма Apple
разрабатывала концепцию FireWire<br>
еще с 1986 года, имя FireWire является самым распростра-<br>
ненным синонимом IEEE 1394.</font> </p>

<p><font face="Times New Roman" size="2">Кроме основного стандарта
IEEE 1394-1995, имеется несколь-<br>
ко его модификаций:</font> </p>

<p><font face="Times New Roman" size="2">^ 1394а рассматривается как
чистовой документ, заполня-<br>
ющий некоторые пробелы исходного стандарта и
имею-<br>
щий небольшие изменения (например, ускоренную
опе-<br>
рацию сброса на шине). Продуктам 1394а обеспечена<br>
обратная совместимость с устройствами,
выпущенными<br>
до принятия основного стандарта. Версия
вводилась для<br>
повышения скорости до 800 Мбит/с и выше, высокоско-<br>
ростные версии входят и в 1394Ь.</font> </p>

<p><font face="Times New Roman" size="2">^ 1394.1 определяет
4-проводньш соединитель и устанав-<br>
ливает стандарт на шинные мосты.</font> </p>

<hr>

<p><font face="Times New Roman" size="2">^ 1394.2 предполагается как
стандарт на соединение клас-<br>
тера станций со скоростью обмена 1 Гбит/с и выше, <i>не-<br>
совместимый с</i> 1394. Этот стандарт проистекает из<br>
IEEE 1596 SCI (Scalable Coherent Interface - масштаби-<br>
руемый когерентный интерфейс) для
суперкомпьютеров<br>
и иногда называется <i>Serial Express</i> или <i>SCILite.</i>
Сигналь-<br>
ный интерфейс 1394.2 похож на FCAL и допускает <i>коль-<br>
цевую топологию,</i> запрещаемую стандартом 1394.</font>
</p>

<p><font face="Times New Roman" size="3"><b>7.2.3. Сравнение FireWire и USB</b></font>
</p>

<p><font face="Times New Roman" size="2">Последовательные
интерфейсы FireWire и USB, имея общие<br>
черты, являются существенно различными
технологиями.<br>
Обе шины обеспечивают простое подключение
большого<br>
числа ПУ (127 для USB и 63 для FireWire), допуская ком-<br>
мутации и включение/выключение устройств при
работаю-<br>
щей системе. Топология обеих шин достаточно
близка. Хабы<br>
USB входят в состав ЦУ; для пользователя их
присутствие<br>
незаметно. Обе шины имеют линии питания
устройств, но<br>
допустимая мощность для FireWire значительно выше.
Обе<br>
шины поддерживают систему РпР (автоматическое
конфи-<br>
гурирование при включении/выключении) и снимают
про-<br>
блему дефицита адресов, каналов DMA и прерываний.
Раз-<br>
личаются пропускная способность и управление
шиной.</font> </p>

<p><font face="Times New Roman" size="2"><i>USB</i> ориентирована на ПУ,
подключаемые к PC. Ее изо-<br>
хронные передачи позволяют передавать только
цифровые<br>
аудиосигналы. Все передачи управляются
централизованно,<br>
и PC является необходимым управляющим узлом,
находя-<br>
щимся в корне древовидной структуры шины.
Соединение<br>
нескольких PC этой шиной не предусматривается.</font>
</p>

<p><font face="Times New Roman" size="2"><i>FireWire</i> ориентирована на
интенсивный обмен между лю-<br>
быми подключенными к ней устройствами.
Изохронньш тра-<br>
фик позволяет передавать &quot;живое&quot; видео. Шина
не требует<br>
централизованного управления со стороны PC.
Возможно<br>
использование шины для объединения нескольких PC
и ПУ<br>
в локальную сеть.</font> </p>

<p><font face="Times New Roman" size="2">Новые устройства
цифрового видео и аудио имеют встроен-<br>
ные адаптеры 1394. Подключение к шине FireWire традици-<br>
онных аналоговых и цифровых устройств (плейеров,
камер,</font> </p>

<hr>

<p><font face="Times New Roman" size="2">мониторов) возможно через
адаптеры-преобразователи ин-<br>
терфейсов и сигналов. Стандартные однотипные
кабели и<br>
разъемы FireWire заменяют множество разнородных
соеди-<br>
нений устройств бытовой электроники с PC.
Разнотипные<br>
цифровые сигналы мультиплексируются в одну шину.
В от-<br>
личие от сетей Ethernet, высокоскоростные передачи
пото-<br>
ков данных по FireWire в реальном времени не требуют
до-<br>
полнительных протоколов. Кроме того, имеются
средства<br>
арбитража, гарантирующие доступ к шине за
заданное вре-<br>
мя. Применение мостов в сетях FireWire позволяет
изоли-<br>
ровать трафик групп узлов друг от друга.</font> </p>

<p><font face="Times New Roman" size="4"><b>7.3. Шина ACCESS.Bus<br>
и интерфейс PC</b></font> </p>

<p><font face="Times New Roman" size="2">Последовательная шина <i>ACCESS.Bus</i>
(Accessory Bus), разра-<br>
ботанная фирмой DEC, является шиной
взаимодействия<br>
компьютера с его аксессуарами - например,
монитором (ка-<br>
нал VESA DDC), интеллектуальными источниками питания<br>
(Smart Battery) и т. п. Шина позволяет по двум сигналь-<br>
ным и двум питающим (12 В, 500 мА) проводам подклю-<br>
чить до 14 устройств ввода/вывода, длина шины
может до-<br>
стигать 8 м. Аппаратной основой является
интерфейс PC,<br>
характеризуемый простотой реализации, но, даже
по срав-<br>
нению с USB, низкой производительностью. Над
аппарат-<br>
ным протоколом PC для шины ACCESS.Bus имеется базо-<br>
вый программный протокол, с которым
взаимодействуют<br>
протоколы конкретных подключенных устройств.
Протоко-<br>
лы обеспечивают подключение/отключение
устройств без пе-<br>
резагрузки ОС. Назначение сигналов разъема
ACCESS.Bus,<br>
предложенное VESA, приведено в табл. 7.3.</font> </p>

<table align="left" border="1">
  <tr>
    <td><font face="Times New Roman" size="2">Контакт</font> </td>
    <td><font face="Times New Roman" size="2">Назначение</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2">1</font> </td>
    <td><font face="Times New Roman" size="2">GND</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2">2</font> </td>
    <td><font face="Times New Roman" size="2">Ключ</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2">3</font> </td>
    <td><font face="Times New Roman" size="2">SDA</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2">4</font> </td>
    <td><font face="Times New Roman" size="2">+5 В (питание устройств)</font>
    </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2">5</font> </td>
    <td><font face="Times New Roman" size="2">SCL</font> </td>
  </tr>
</table>

<p><br clear="all">
</p>

<hr>

<p><font face="Times New Roman" size="2">Интерфейс <i>К,</i>
разработанный фирмой Philips, в PC появил-<br>
ся недавно и используется как внутренняя
вспомогательная<br>
шина системной платы для общения с
энергонезависимой<br>
памятью идентификации установленных
компонентов (мо-<br>
дулей памяти DIMM). Шина отличается предельной про-<br>
стотой реализации - две сигнальные линии, с
которыми ра-<br>
ботают программно. По прямому назначению эту
шину<br>
применяет пока только BIOS при определении
аппаратных<br>
средств, но использование перезаписываемой
памяти конфи-<br>
гурирования открывает новые возможности для
привязки<br>
ПО к конкретной системе (точнее, установленному
модулю)<br>
и... для вирусов. Способ программного доступа к
шине пока<br>
не стандартизован, но при желании его можно
&quot;вычислить&quot;,<br>
изучив документацию на чипсет.</font> </p>

<p><img border="0" vspace="3" hspace="3" src="710.jpg" alt="710.jpg" width="880"
height="156"> <br clear="all">
</p>

<p align="center"><font face="Times New Roman" size="2"><b>Рис. 7.12.</b>
Протокол передачи данных PC</font> </p>

<p><font face="Times New Roman" size="2">Последовательный
интерфейс <i>УС</i> обеспечивает двунаправ-<br>
ленную передачу данных между парой устройств,
исполь-<br>
зуя два сигнала: данные SDA (Serial Data) и синхронизацию<br>
SCL (Serial Clock). В обмене участвуют два устройства - <i>ве-<br>
дущее (Master)</i> и <i>ведомое (Slave).</i> Каждое из них
может вы-<br>
ступать в роли <i>передатчика,</i> помещающего на
линию SDA<br>
информационные биты, или <i>приемника.</i> Протокол
обмена<br>
иллюстрирует рис. 7.12. Синхронизацию задает
ведущее ус-<br>
тройство - контроллер. Линия данных -
двунаправленная с<br>
выходом типа &quot;открытый коллектор&quot; -
управляется обоими<br>
устройствами поочередно. Частота обмена (не
обязательно<br>
постоянная) ограничена сверху величиной 100 кГц
для стан-<br>
дартного режима и 400 кГц для скоростного, что
позволяет<br>
организовать программно-управляемую реализацию
контрол-<br>
лера интерфейса.</font> </p>

<p><font face="Times New Roman" size="2">Начало любой операции -
условие <i>Start -</i> инициируется<br>
переводом сигнала SDA из высокого в низкий при
высоком<br>
уровне SCL. Завершается операция переводом
сигнала SDA</font> </p>

<hr>

<p><font face="Times New Roman" size="2">из низкого уровня в
высокий при высоком уровне SCL -<br>
условие <i>Stop.</i> При передаче данных состояние
линии SDA<br>
может изменяться только при низком уровне SCL,
биты дан-<br>
ных стробируются положительным перепадом SCL
Каждая<br>
посылка состоит из 8 бит данных, формируемых
передатчи-<br>
ком (старший бит - MSB - передается первым), после
чего<br>
передатчик на один такт освобождает линию данных
для<br>
получения подтверждения. Приемник во время
девятого так-<br>
та формирует нулевой <i>бит подтверждения Ack.</i>
После пере-<br>
дачи бита подтверждения приемник может
задержать сле-<br>
дующую посылку, удерживая линию SCL на низком
уровне.<br>
Приемник также может замедлить передачу по шине
на уров-<br>
не приема каждого бита, удерживая SCL на низком
уровне<br>
после его спада, сформированного передатчиком.</font>
</p>

<p><font face="Times New Roman" size="2">Каждое ведомое устройство
имеет свой адрес, разрядность ко-<br>
торого по умолчанию составляет 7 бит. Адрес <i>А[6:0]</i>
передается<br>
ведущим устройством в битах [7:1] первого байта,
бит 0 содер-<br>
жит признак операции Я1У(Я1/У=1 - чтение, <i>RW=Q</i>
-запись).<br>
7-битный адрес содержит две части: старшие 4 бита <i>А[6:3]</i>
не-<br>
сут информацию о типе устройства (например, для<br>
EEPROM - 1010), а младшие 3 бита <i>А[0:2]</i> определяют
номер<br>
устройства данного типа. Многие микросхемы с
интерфей-<br>
сом PC имеют три адресных входа, коммутацией
которых на<br>
логические уровни 1 и 0 задается требуемый адрес.
Некото-<br>
рые значения полного адреса зарезервированы
(табл. 7.4).</font> </p>

<p><font face="Times New Roman" size="2">Общий вызов позволяет
включившемуся устройству заявить<br>
о себе широковещательным способом. Байт <i>Start</i>
предназна-<br>
чен для привлечения внимания процессора к
интерфейсу, если<br>
в устройстве он организован программным (не
аппаратным)<br>
способом. До получения этого байта
микроконтроллер уст-<br>
ройства не опрашивает состояние и не следит за
сигналами<br>
интерфейса. При использовании 10-битной адресации
биты<br>
[2:1] содержат старшую часть адреса, а младшие 8 бит
будут<br>
переданы в следующем байте, если признак <i>RW=0.</i></font>
</p>

<p><font face="Times New Roman" size="2">Адрес ведомого устройства
и тип обращения задается кон-<br>
троллером при инициировании обмена. Обмен с
памятью<br>
иллюстрирует рис. 7.13. Здесь SA[0:2] - адрес
устройства,<br>
DA[0:7] - адрес данных, D[0:7] - данные, W - признак за-<br>
писи (0), R - признак чтения (1).</font> </p>

<hr>

<table align="left" border="1">
  <tr>
    <td><font face="Times New Roman" size="2">Биты [7:1]</font> </td>
    <td><font face="Times New Roman" size="2">BKTO(RW)</font> </td>
    <td><font face="Times New Roman" size="2">Назначение</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2">0000 000</font> </td>
    <td><font face="Times New Roman" size="2">0</font> </td>
    <td><font face="Times New Roman" size="2"><i>General call address -</i> адрес
    общего вызова</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2">0000 000</font> </td>
    <td><font face="Times New Roman" size="2">1</font> </td>
    <td><font face="Times New Roman" size="2"><i>Start. -</i> начало активного
    обмена</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2">0000 001</font> </td>
    <td><font face="Times New Roman" size="2">X</font> </td>
    <td><font face="Times New Roman" size="2">Адрес устройства шины CBUS
    (для сов-<br>
    местимости)</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2">0000 010</font> </td>
    <td><font face="Times New Roman" size="2">X</font> </td>
    <td><font face="Times New Roman" size="2">Адрес для устройств иных
    шин</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2">0000 011</font> </td>
    <td><font face="Times New Roman" size="2">X</font> </td>
    <td><font face="Times New Roman" size="2">Зарезервировано</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2">0000 1ХХ</font> </td>
    <td><font face="Times New Roman" size="2">X</font> </td>
    <td><font face="Times New Roman" size="2">Зарезервировано</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2">1111 1ХХ</font> </td>
    <td><font face="Times New Roman" size="2">X</font> </td>
    <td><font face="Times New Roman" size="2">Зарезервировано</font> </td>
  </tr>
  <tr>
    <td><font face="Times New Roman" size="2">1111 ОХХ</font> </td>
    <td><font face="Times New Roman" size="2">X</font> </td>
    <td><font face="Times New Roman" size="2">Признак 10-битной
    адресации</font> </td>
  </tr>
</table>

<p><br clear="all">
</p>

<p><img border="0" vspace="3" hspace="3" src="711.jpg" alt="711.jpg" width="900"
height="428"> <br clear="all">
</p>

<p align="center"><font face="Times New Roman" size="2"><b>Рис. 7.13.</b> Обмен с
памятью по интерфейсу PC: a - запись,<br>
б - чтение с текущего адреса,<br>
<i>в -</i> чтение с произвольного адреса</font> </p>

<p><font face="Times New Roman" size="2">Выполнив условие <i>Start,</i>
контроллер передает байт, содер-<br>
жащий адрес устройства и признак операции <i>RW,</i>
и ожидает<br>
подтверждения. При <i>операции записи</i> следующей
посылкой<br>
от контроллера будет 8-битный адрес записываемой
ячейки,<br>
а за ней - байт данных (для микросхем объемом
памяти бо-<br>
лее 256 байт адрес ячейки посылается двумя
байтами). По-<br>
лучив подтверждения, контроллер завершает цикл
услови-<br>
ем <i>Stop,</i> а адресованное устройство может начать
свой<br>
внутренний цикл записи, во время которого не
реагирует на<br>
сигналы интерфейса. Контроллер проверяет
готовность уст-<br>
ройства посылкой команды записи (байт адреса
устройства)</font> </p>

<hr>

<p><font face="Times New Roman" size="2">и анализом бита
подтверждения, формируя затем условие<br>
<i>Stop.</i> Если устройство откликнулось битом
подтверждения,<br>
значит, оно завершило внутренний цикл и готово к
следую-<br>
щей операции.</font> </p>

<p><font face="Times New Roman" size="2"><i>Операция считывания</i>
инициируется так же, как и запись,<br>
но с признаком <i>RW=\.</i> Возможно чтение по
заданному адре-<br>
су, по текущему адресу или последовательное.
Текущий ад-<br>
рес хранится во внутреннем счетчике ведомого
устройства,<br>
он содержит увеличенный на единицу адрес ячейки,
участво-<br>
вавшей в последней операции.</font> </p>

<p><font face="Times New Roman" size="2">Получив команду чтения,
устройство дает бит подтвержде-<br>
ния и посылает байт данных, соответствующий
текущему<br>
адресу. Контроллер может ответить
подтверждением, тогда<br>
устройство пошлет следующий байт
(последовательное чте-<br>
ние). Если на принятый байт данных контроллер
ответит<br>
условием <i>Stop,</i> операция чтения завершается
(случай чтения<br>
по текущему адресу). Начальный адрес для
считывания кон-<br>
троллер задает фиктивной операцией записи, в
которой пе-<br>
редается байт адреса устройства и байт адреса
ячейки, а после<br>
подтверждения приема байта адреса снова
формируется ус-<br>
ловие <i>Start</i> и передается адрес устройства, но
уже с указа-<br>
нием на операцию чтения. Так реализуется
считывание про-<br>
извольной ячейки (или последовательности ячеек).</font>
</p>

<p><font face="Times New Roman" size="2">Интерфейс позволяет
контроллеру с помощью пары сигна-<br>
лов обращаться к любому из 8 однотипных
устройств, под-<br>
ключенных к данной шине и имеющих уникальный
адрес<br>
(рис. 7.14). При необходимости увеличения
количества уст-<br>
ройств возможно подключение групп. При этом
допустимо<br>
как использование общего сигнала SCL и раздельных
сигна-<br>
лов SDA (двунаправленных), так и общего сигнала SDA и<br>
раздельных однонаправленных сигналов SCL. Для
обраще-<br>
ния к одной из нескольких микросхем (или
устройств), не<br>
имеющих выводов для задания собственного адреса,
также<br>
применяют разделение линий SCL (или SDA).</font> </p>

<p><font face="Times New Roman" size="2">Протокол PC позволяет
нескольким контроллерам исполь-<br>
зовать одну шину, определяя коллизии и выполняя
арбит-<br>
раж. Эти функции реализуются достаточно просто:
если два<br>
передатчика пытаются установить на линии SDA
различные</font> </p>

<hr>

<p><font face="Times New Roman" size="2">логические уровни
сигналов, то &quot;победит&quot; тот, который ус-<br>
тановит низкий уровень. Передатчик следит за
уровнями<br>
управляемых им сигналов и при обнаружении
несоответствия<br>
(передает высокий уровень, а &quot;видит&quot; низкий)
отказывает-<br>
ся от дальнейшей передачи. Устройство может
иницииро-<br>
вать обмен только при пассивном состоянии
сигналов. Кол-<br>
лизия может возникнуть лишь при одновременной
попытке<br>
начала обмена - как только конфликт обнаружен,
&quot;проиг-<br>
равший&quot; передатчик отключится, а
&quot;победивший&quot; продол-<br>
жит работу.</font> </p>

<p><img border="0" vspace="3" hspace="3" src="712.jpg" alt="712.jpg" width="750"
height="236"> <br clear="all">
</p>

<p align="center"><font face="Times New Roman" size="2"><b>Рис.7.14.</b>
Подключение устройств к контроллеру <i>^С</i></font> </p>

<hr>

<p><font face="Times New Roman" size="5"><b>Приложение А.<br>
Системотехника<br>
IBM PC-совместимых<br>
компьютеров</b></font> </p>

<p><font face="Times New Roman" size="2">Здесь рассмотрено
взаимодействие программ с интерфейс-<br>
ными адаптерами. Приведены краткие сведения по
архитек-<br>
туре PC. Описаны организация пространств памяти и
вво-<br>
да/вывода, система прерываний и прямой доступ к
памяти.<br>
Более подробные сведения можно найти в книге
&quot;Аппарат-<br>
ные средства IBM PC. Энциклопедия&quot; (&quot;Питер&quot;,
1998).</font> </p>

<p><font face="Times New Roman" size="4"><b>А.1. Пространство памяти</b></font>
</p>

<p><font face="Times New Roman" size="2">Логическая структура
памяти PC обусловлена системой ад-<br>
ресации процессоров семейства х86. Процессоры
8086/88,<br>
применявшиеся в первых моделях IBM PC, имели
адресное<br>
пространство 1 Мбайт (20 бит шины адреса). Начиная с
про-<br>
цессора 80286 шина адреса была расширена до 24 бит,
затем<br>
(386DX, 486, Pentium) до 32 и, наконец, до 36 бит<br>
(Pentium Pro, Pentium II). В реальном режиме процессора,<br>
используемом в DOS, формально доступен лишь 1 Мбайт<br>
памяти. Однако из-за ошибки эмуляции процессора
8086 в<br>
реальном режиме процессоры 80286 и выше имеют
макси-<br>
мально доступный адрес lOFFEFh, что на (64К-16) байт<br>
больше. Область lOOOOOh-lOFFEFh называется <i>высокой па-<br>
мятью - High Memory Area</i> (HMA). В нее помещают часть<br>
ОС реального режима и небольшие резидентные
програм-<br>
мы. Для полной совместимости с процессором 8086/88
име-<br>
ется вентиль линии А20 шины адреса - <i>GateA20,</i>
который<br>
либо пропускает сигнал от процессора, либо
принудительно<br>
обнуляет линию А20 системной шины адреса.</font> </p>
<HR>
<TABLE WIDTH=100%>
<TR>
<TD align=right valign=top> 
<p>
<DIV ALIGN=center><i><h5>Электронная библиотека InfoCity</i></h5></DIV>
<DIV ALIGN=center><i><h5>Автор и координатор проекта:<a href=mailto:mpinkus@mail.ru>Михаил Пинкус</a></i></h5></DIV>
<DIV ALIGN=center><i><h5>У Вас есть документация, которой нет в нашей библиотеке? <a href="mailto:icity@mail.ru?subject=InfoCity - Doc">Присылайте.</a></h5>
</TD>
</TR></table>
</body>
</html>
